<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medteria 問題集テスト</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 基本スタイルの設定 */
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f0f4f8;
            background-image: radial-gradient(#dbeafe 1px, transparent 1px), radial-gradient(#dbeafe 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }

        /* ガラスモーフィズムの基本スタイル */
        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* ボタンのホバー・アクティブエフェクト */
        .btn-primary {
            @apply bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 transform hover:scale-105;
        }
        
        .btn-secondary {
            @apply bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 transition-all duration-300;
        }

        /* トースト通知のアニメーション */
        @keyframes toast-in {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .toast-in {
            animation: toast-in 0.5s ease-out forwards;
        }

        /* 投票ボタンのアニメーション */
        @keyframes vote-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
        .vote-pop-animation {
            animation: vote-pop 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- ヘッダー -->
    <header class="glassmorphism sticky top-0 z-40 w-full px-4 sm:px-6 py-3">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Medteria 問題集テスト</h1>
            <div class="flex items-center space-x-3 sm:space-x-4">
                <button class="text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="search" class="w-6 h-6"></i>
                </button>
                <button id="settings-button" class="text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main id="quiz-container" class="flex-grow w-full max-w-3xl mx-auto px-4 py-8 space-y-8">
        <!-- 問題はここに動的に追加されます -->
    </main>

    <!-- 次の問題へボタン -->
    <div class="px-4 my-8 text-center">
        <button id="next-question-button" class="btn-primary text-lg px-8 py-3">次の問題へ</button>
    </div>

    <!-- フッター -->
    <footer class="w-full text-center p-4 text-gray-500 text-sm">
        <p>&copy; 2025 copyright Medteria All rights reserved.</p>
    </footer>

    <!-- ページ下部へスクロールするボタン -->
    <button id="scroll-to-bottom" class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full p-3 shadow-lg hover:bg-blue-700 transition-all duration-300 z-50">
        <i data-lucide="arrow-down" class="w-6 h-6"></i>
    </button>
    
    <!-- トースト通知コンテナ -->
    <div id="toast-container" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <!-- 設定モーダル -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="glassmorphism rounded-2xl w-11/12 max-w-md p-6 m-4 flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">解答状況</h2>
            <div class="flex-grow space-y-3 text-gray-700">
                <p>現在の解答数: <span id="answered-count">0</span>問</p>
                <p>正解数: <span id="correct-count">3</span>問 (ダミー)</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: 45%"></div>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row-reverse gap-3">
                <button class="btn-primary w-full sm:w-auto">保存して終了する</button>
                <button id="close-settings-modal" class="btn-secondary w-full sm:w-auto">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 修正依頼モーダル -->
    <div id="correction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="glassmorphism rounded-2xl w-11/12 max-w-md p-6 m-4 flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">修正内容を報告</h2>
            <div class="flex-grow space-y-4">
                <p class="text-gray-600">問題や解説に関するフィードバックをお聞かせください。</p>
                <div id="correction-options" class="space-y-2">
                    <button data-reason="difficult" class="correction-option w-full text-left p-3 rounded-lg border border-gray-300 bg-white hover:bg-blue-50 transition-colors">文章が難しすぎる</button>
                    <button data-reason="long" class="correction-option w-full text-left p-3 rounded-lg border border-gray-300 bg-white hover:bg-blue-50 transition-colors">解説が長すぎる</button>
                    <button data-reason="short" class="correction-option w-full text-left p-3 rounded-lg border border-gray-300 bg-white hover:bg-blue-50 transition-colors">解説が短すぎる</button>
                    <button data-reason="error" class="correction-option w-full text-left p-3 rounded-lg border border-gray-300 bg-white hover:bg-blue-50 transition-colors">医学的に誤りがある</button>
                </div>
                <textarea id="correction-text" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" rows="4" placeholder="その他の場合は、こちらに詳細をご記入ください。"></textarea>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row-reverse gap-3">
                <button id="submit-correction" class="btn-primary w-full sm:w-auto">送信する</button>
                <button id="close-correction-modal" class="btn-secondary w-full sm:w-auto">キャンセル</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Lucideアイコンの初期化
            lucide.createIcons();

            // 問題データ
            const quizData = [
                {
                    id: 1,
                    difficulty: '国家試験より易しい',
                    question: 'インスリン分泌促進系に分類されるのはどれか。',
                    choices: [
                        'a. チアゾリジン薬',
                        'b. ビグアナイド薬',
                        'c. α-グルコシダーゼ阻害薬',
                        'd. DPP-4 (dipeptidyl peptidase-4) 阻害薬',
                        'e. SGLT2 (sodium glucose cotransporter 2) 阻害薬'
                    ],
                    answer: 'd',
                    explanation: '本問は血糖降下薬の作用機序による分類を問う問題です。<br>• a. チアゾリジン薬： PPARγを活性化し、インスリン抵抗性を改善します。インスリン分泌は促進しません。<br>• b. ビグアナイド薬： 主に肝臓での糖新生を抑制し、インスリン抵抗性を改善します。インスリン分泌は促進しません。<br>• c. α-グルコシダーゼ阻害薬： 腸管での二糖類の分解を阻害し、糖の吸収を遅らせます。インスリン分泌は促進しません。<br>• d. DPP-4阻害薬： インクレチン（GLP-1など）の分解を阻害することで血中濃度を高め、血糖依存的にインスリン分泌を促進し、グルカゴン分泌を抑制します。これが正解です。<br>• e. SGLT2阻害薬： 腎臓の近位尿細管でのブドウ糖再吸収を抑制し、尿中への糖排泄を促進します。インスリン非依存的に血糖を低下させます。'
                },
                {
                    id: 2,
                    difficulty: '国家試験より易しい',
                    question: 'ツベルクリン反応に関連する免疫反応はどれか。',
                    choices: [
                        'a. I型アレルギー',
                        'b. II型アレルギー',
                        'c. III型アレルギー',
                        'd. IV型アレルギー',
                        'e. V型アレルギー'
                    ],
                    answer: 'd',
                    explanation: 'ツベルクリン反応は、結核菌に対する細胞性免疫の有無を調べる皮内反応であり、Gell-Coombs分類における<b>IV型アレルギー（遅延型アレルギー）</b>の代表例です。抗原提示細胞によって提示された結核菌抗原に対し、感作T細胞が反応し、サイトカインを放出してマクロファージなどを活性化させることで、48〜72時間後に発赤・硬結がピークに達します。<br>• I型（即時型）： IgEが関与。花粉症、気管支喘息、アナフィラキシーなど。<br>• II型（細胞障害型）： IgG, IgMが自己の細胞表面抗原に結合し、補体や食細胞を介して細胞を破壊。自己免疫性溶血性貧血、血小板減少症など。<br>• III型（免疫複合体型）： 抗原と抗体（IgG, IgM）の免疫複合体が組織に沈着し、補体を活性化して炎症を引き起こす。ループス腎炎、血清病など。'
                },
                {
                    id: 3,
                    difficulty: '国家試験より易しい',
                    question: 'Which contributes to coordinated movement?',
                    choices: [
                        'a. Frontal lobe',
                        'b. Parietal lobe',
                        'c. Occipital lobe',
                        'd. Temporal lobe',
                        'e. Cerebellum'
                    ],
                    answer: 'e',
                    explanation: '協調運動（coordinated movement）は、複数の筋肉の活動を時間的・空間的に適切に統合し、滑らかで正確な運動を実現する機能です。この中枢は<b>小脳（Cerebellum）</b>です。小脳が障害されると、運動失調（ataxia）をきたし、測定障害（dysmetria）や協調運動反復不能（adiadochokinesis）などがみられます。<br>• a. 前頭葉： 思考、意思決定、運動の企画（運動野）。<br>• b. 頭頂葉： 感覚情報の統合（体性感覚野）。<br>• c. 後頭葉： 視覚情報の処理（視覚野）。<br>• d. 側頭葉： 聴覚、記憶、言語理解（ウェルニッケ野）。'
                },
                {
                    id: 28,
                    difficulty: '★★★☆☆ 国家試験レベル',
                    question: '35歳の男性。左顎下部の腫脹を主訴に来院した。数か月前より時々起こる左顎下部の腫脹に気付いていたが経過をみていた。最近食後に左顎下部腫脹が頻繁に起こり、数時間で腫脹は改善する。腫脹時は軽度の痛みを伴うため来院した。身長 174 cm、体重 70.5 kg。体温 36.4℃。左顎下腺は右よりやや大きく、全体的に硬く触知した。触診により軽度の圧痛を伴った。血液所見：赤血球 515万、Hb 15.2 g/dL、Ht 44.5%、白血球 8,600、血小板 19.8万。血液生化学所見：総蛋白 7.5 g/dL、アルブミン 4.2 g/dL、総ビリルビン 1.0 mg/dL、AST 19 U/L、ALT 24 U/L、LD 173 U/L (基準120〜245)、ALP 67 U/L (基準38〜113)、アミラーゼ 155 U/L (基準37〜160)、CK 110 U/L (基準30〜140)、尿素窒素 19 mg/dL、クレアチニン 0.69 mg/dL。CRP 1.2 mg/dL。<br><br>確定診断に必要な検査はどれか。2つ選べ。',
                    choices: [
                        'a. 頸部CT',
                        'b. IgG4測定',
                        'c. 抗SS-A抗体測定',
                        'd. 口腔底の双手診',
                        'e. 穿刺吸引細胞診'
                    ],
                    answer: 'a, d',
                    explanation: '食事のたびに繰り返す顎下部の腫脹と疼痛は、唾石症による唾液のうっ滞（唾仙痛）を強く示唆します。特に顎下腺に好発します。<br>• a. 頸部CT: 唾石の存在部位や大きさ、顎下腺の腫脹や炎症の程度を評価するために非常に有用です。特に石灰化の程度が低い唾石の描出に優れます。<br>• d. 口腔底の双手診: 口腔内からと口腔外からの両方から触診することで、顎下腺管内の唾石を触知できることがあります。基本的な診察手技として重要です。<br>• b. IgG4測定やc. 抗SS-A抗体測定は、それぞれIgG4関連疾患やシェーグレン症候群といった自己免疫性唾液腺炎を疑う場合に行いますが、本症例のように食事と関連した間欠的な症状からは、まず唾石症を考えます。<br>• e. 穿刺吸引細胞診は、腫瘍性病変が疑われる場合に行いますが、第一選択の検査ではありません。'
                }
            ];

            const quizContainer = document.getElementById('quiz-container');
            const nextQuestionButton = document.getElementById('next-question-button');
            const answeredCountEl = document.getElementById('answered-count');
            let currentQuestionIndex = 0;

            // 問題を生成する関数
            function createQuestionElement(q, index) {
                const choicesHTML = q.choices.map(choice => `<li class="text-gray-700 leading-relaxed">${choice}</li>`).join('');
                const questionCard = document.createElement('div');
                questionCard.className = 'glassmorphism rounded-2xl p-6 sm:p-8';
                questionCard.id = `question-${q.id}`;
                questionCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-2xl font-bold text-blue-700">問題 ${index + 1}</span>
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-1 rounded-full">${q.difficulty}</span>
                    </div>
                    <div class="prose max-w-none">
                        <p class="text-gray-800 text-lg font-medium">${q.question}</p>
                        <ul class="list-none p-0 mt-4 space-y-2">${choicesHTML}</ul>
                    </div>
                    <div class="mt-6 text-center">
                        <button class="show-answer-btn btn-primary" data-question-id="${q.id}">回答を表示する</button>
                    </div>
                    <div class="answer-container mt-6 border-t border-gray-300 pt-6 hidden"></div>
                `;
                return questionCard;
            }

            // 回答を生成する関数
            function createAnswerElement(q) {
                return `
                    <h3 class="text-lg font-bold text-gray-800 mb-2">正解：${q.answer}</h3>
                    <div class="prose prose-sm max-w-none text-gray-600">${q.explanation}</div>
                    <div class="flex items-center justify-end space-x-4 mt-6 vote-buttons">
                        <button class="vote-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-vote="good" title="役に立った">
                            <i data-lucide="thumbs-up" class="w-5 h-5 text-gray-500"></i>
                        </button>
                        <button class="vote-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-vote="bad" title="役に立たなかった">
                            <i data-lucide="thumbs-down" class="w-5 h-5 text-gray-500"></i>
                        </button>
                        <button class="vote-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-vote="share" title="共有する">
                            <i data-lucide="share-2" class="w-5 h-5 text-gray-500"></i>
                        </button>
                        <button class="correction-request-btn p-2 rounded-full hover:bg-gray-200 transition-colors" title="修正を依頼する">
                            <i data-lucide="edit" class="w-5 h-5 text-gray-500"></i>
                        </button>
                    </div>
                `;
            }
            
            // トースト通知を表示する関数
            function showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = {
                    info: 'bg-blue-500',
                    success: 'bg-green-500',
                    error: 'bg-red-500'
                };
                toast.className = `toast-in text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-lg ${colors[type]}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // 次の問題を表示する関数
            function loadNextQuestion() {
                if (currentQuestionIndex < quizData.length) {
                    const question = quizData[currentQuestionIndex];
                    const questionEl = createQuestionElement(question, currentQuestionIndex);
                    quizContainer.appendChild(questionEl);
                    currentQuestionIndex++;
                    answeredCountEl.textContent = currentQuestionIndex;
                    if(currentQuestionIndex === quizData.length) {
                        nextQuestionButton.textContent = '全ての問題を解きました';
                        nextQuestionButton.disabled = true;
                        nextQuestionButton.classList.remove('btn-primary');
                        nextQuestionButton.classList.add('btn-secondary');
                    }
                }
            }
            
            // イベントリスナー
            nextQuestionButton.addEventListener('click', loadNextQuestion);

            quizContainer.addEventListener('click', (e) => {
                // 「回答を表示する」ボタン
                if (e.target && e.target.classList.contains('show-answer-btn')) {
                    const button = e.target;
                    const questionId = button.dataset.questionId;
                    const question = quizData.find(q => q.id == questionId);
                    const questionCard = document.getElementById(`question-${questionId}`);
                    const answerContainer = questionCard.querySelector('.answer-container');
                    
                    answerContainer.innerHTML = createAnswerElement(question);
                    answerContainer.classList.remove('hidden');
                    button.parentElement.classList.add('hidden');
                    lucide.createIcons(); // 動的に追加したアイコンを初期化
                }

                // 投票ボタン
                if (e.target && e.target.closest('.vote-btn')) {
                    const button = e.target.closest('.vote-btn');
                    const voteType = button.dataset.vote;
                    const icon = button.querySelector('i');
                    const voteButtonsContainer = button.parentElement;

                    // アニメーション
                    icon.classList.add('vote-pop-animation');
                    icon.addEventListener('animationend', () => icon.classList.remove('vote-pop-animation'));

                    if (voteType === 'good' || voteType === 'bad') {
                        const goodBtn = voteButtonsContainer.querySelector('[data-vote="good"] i');
                        const badBtn = voteButtonsContainer.querySelector('[data-vote="bad"] i');
                        const isGoodActive = goodBtn.classList.contains('text-blue-600');
                        const isBadActive = badBtn.classList.contains('text-red-600');

                        goodBtn.classList.remove('text-blue-600');
                        badBtn.classList.remove('text-red-600');
                        goodBtn.classList.add('text-gray-500');
                        badBtn.classList.add('text-gray-500');

                        if(voteType === 'good' && !isGoodActive) {
                            goodBtn.classList.add('text-blue-600');
                            goodBtn.classList.remove('text-gray-500');
                            showToast('解説が役に立ったと評価しました', 'success');
                        } else if (voteType === 'bad' && !isBadActive) {
                            badBtn.classList.add('text-red-600');
                            badBtn.classList.remove('text-gray-500');
                            showToast('解説が役に立たなかったと評価しました', 'error');
                        } else {
                            showToast('評価を取り消しました');
                        }

                    } else if (voteType === 'share') {
                        showToast('共有リンクをコピーしました');
                    }
                }
                
                // 修正依頼ボタン
                if (e.target && e.target.closest('.correction-request-btn')) {
                    document.getElementById('correction-modal').classList.remove('hidden');
                }
            });

            // スクロールボタン
            document.getElementById('scroll-to-bottom').addEventListener('click', () => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            });
            
            // --- モーダル関連の処理 ---
            const settingsModal = document.getElementById('settings-modal');
            const correctionModal = document.getElementById('correction-modal');

            // 設定モーダル
            document.getElementById('settings-button').addEventListener('click', () => settingsModal.classList.remove('hidden'));
            document.getElementById('close-settings-modal').addEventListener('click', () => settingsModal.classList.add('hidden'));
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) settingsModal.classList.add('hidden');
            });

            // 修正依頼モーダル
            document.getElementById('close-correction-modal').addEventListener('click', () => correctionModal.classList.add('hidden'));
            correctionModal.addEventListener('click', (e) => {
                if (e.target === correctionModal) correctionModal.classList.add('hidden');
            });
            
            const correctionOptions = document.getElementById('correction-options');
            let selectedReason = null;
            correctionOptions.addEventListener('click', (e) => {
                if(e.target.classList.contains('correction-option')) {
                    // 全てのボタンの選択状態を解除
                    correctionOptions.querySelectorAll('.correction-option').forEach(btn => {
                        btn.classList.remove('bg-blue-100', 'border-blue-500', 'font-semibold');
                        btn.classList.add('bg-white', 'border-gray-300');
                    });
                    
                    // クリックされたボタンを選択状態にする
                    e.target.classList.add('bg-blue-100', 'border-blue-500', 'font-semibold');
                    e.target.classList.remove('bg-white', 'border-gray-300');
                    selectedReason = e.target.dataset.reason;
                }
            });

            document.getElementById('submit-correction').addEventListener('click', () => {
                const otherText = document.getElementById('correction-text').value;
                if (!selectedReason && !otherText.trim()) {
                    showToast('修正理由を選択または入力してください', 'error');
                    return;
                }
                console.log('修正依頼:', { reason: selectedReason, text: otherText });
                correctionModal.classList.add('hidden');
                showToast('修正依頼を送信しました。ご協力ありがとうございます。', 'success');
                
                // フォームをリセット
                correctionOptions.querySelectorAll('.correction-option').forEach(btn => {
                    btn.classList.remove('bg-blue-100', 'border-blue-500', 'font-semibold');
                    btn.classList.add('bg-white', 'border-gray-300');
                });
                document.getElementById('correction-text').value = '';
                selectedReason = null;
            });


            // 初期問題の読み込み
            loadNextQuestion();
        });
    </script>

</body>
</html>
